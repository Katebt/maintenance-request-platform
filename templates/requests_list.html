{% extends "base.html" %}

{% block title %}Ù‚Ø§Ø¦Ù…Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©{% endblock %}

{% block content %}
<h2>Ù‚Ø§Ø¦Ù…Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø© </h2>
<div class="status-cards" style="display:flex; gap:16px; margin-bottom:32px; justify-content: center;">
    <div class="card" style="background:#ffc1071a; padding:22px 36px; border-radius:15px; box-shadow:0 2px 6px #0001;">
        <h3 style="color:#dc9a00; margin:0;">Ø¬Ø¯ÙŠØ¯ </h3>
        <div style="font-size:2em; font-weight:bold;">{{ new }}</div>
    </div>

    <div class="card" style="background:#0d6efd1a; padding:22px 36px; border-radius:15px; box-shadow:0 2px 6px #0001;">
        <h3 style="color:#0d6efd; margin:0;">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</h3>
        <div style="font-size:2em; font-weight:bold;">{{ inprogress_count }}</div>
    </div>
        <div class="card" style="background:#8d5f001a; padding:22px 36px; border-radius:15px; box-shadow:0 2px 6px #0001;">
        <h3 style="color:#b08906; margin:0;">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</h3>
        <div style="font-size:2em; font-weight:bold;">{{ pending_approval_count }}</div>
    </div>


    <div class="card" style="background:#1987541a; padding:22px 36px; border-radius:15px; box-shadow:0 2px 6px #0001;">
        <h3 style="color:#198754; margin:0;">Ù…ÙƒØªÙ…Ù„</h3>
        <div style="font-size:2em; font-weight:bold;">{{ completed_count }}</div>
    </div>
    <div class="card" style="background:#dc35451a; padding:22px 36px; border-radius:15px; box-shadow:0 2px 6px #0001;">
        <h3 style="color:#dc3545; margin:0;">Ù…ØºÙ„Ù‚</h3>
        <div style="font-size:2em; font-weight:bold;">{{ closed_count }}</div>
    </div>
</div>
<table border="1" cellpadding="8" cellspacing="0" style="width:100%; text-align:center;">
    <thead>
        <tr>
            <th>Ø±Ù‚Ù… Ø§Ù„Ø¨Ù„Ø§Øº</th>
             <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</th>
            <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø§Ù„Ù‚Ø³Ù…</th>
            <th>Ø§Ù„ØªØµÙ†ÙŠÙ</th>
            <th>Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„ÙØ±Ø¹ÙŠ</th>
            <th>Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ø§Ù„Ù…Ø¹ÙŠÙ‘Ù†</th>
            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
             <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„</th>
        </tr>
    </thead>
    <tbody>
    {% for req in requests %}
        <tr>
            <td>{{ req.id }}</td>
                <td>
            {{ req.created_at.strftime('%Y-%m-%d ') if req.created_at else "-" }}
        </td>

            <td>{{ req.title }}</td>
            <td>
                {% if req.status == 'Pending Approval' %}
                    <div style="display:flex; align-items:center; justify-content:center; gap:10px; background:#fffbea; border-radius:8px; padding:6px 3px;">
                        <span style="color:#a87400; font-weight:bold; font-size:0.93em;">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© </span>
                        <!-- Ø²Ø± Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø·Ù„Ø¨ ÙƒÙ€ Ù…ÙƒØªÙ…Ù„ (ÙÙ‚Ø· Ø¥Ø°Ø§ Ø§Ù„Ù…Ø¯ÙŠØ± ÙˆÙŠØ±Ù‰ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©) -->
                        {% if user and user.role == "manager" and req.status == "Pending Approval" %}
                            <div style="margin-top:18px;">
                                <button class="btn btn-success" onclick="approveAsCompleted({{ req.id }}, this)" type="button">
                                    Ø§Ø¹ØªÙ…Ø§Ø¯ âœ…
                                </button>
                                <span id="msg-{{ req.id }}" style="color:green; font-weight:bold; margin-right:10px;"></span>
                            </div>
                        {% endif %}
                    </div>
                {% else %}
                    <span style="font-size:0.96em;">{{ req.status }}</span>
                {% endif %}
            </td>
                        <td>{{ req.department }}</td>
            <td>{{ req.category if req.category else "ØºÙŠØ± Ù…Ø­Ø¯Ø¯" }}</td>
            <td>{{ req.sub_category if req.sub_category else "ØºÙŠØ± Ù…Ø­Ø¯Ø¯" }}</td>
            <td>
                {% if req.assigned_engineer %}
                    {{ req.assigned_engineer.name }}
                {% elif req.assigned_engineer_id %}
                    {{ req.assigned_engineer_id }}
                {% else %}
                    ØºÙŠØ± Ù…Ø¹ÙŠÙ†
                {% endif %}
            </td>
           <td>
        {% if user.role in ["manager", "engineer", "admin", "superuser"] %}
            <a href="/requests/{{ req.id }}">Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</a>
            {% if user.role == "manager" %}
                | <a href="/requests/{{ req.id }}/edit">ØªØ¹Ø¯ÙŠÙ„/ØªØ¹ÙŠÙŠÙ†</a>
            {% endif %}
        {% else %}
            -
        {% endif %}
    </td>
                  <td>
            {% if req.status == "Completed" and req.updated_at %}
                {{ req.updated_at.strftime('%Y-%m-%d') }}
            {% else %}
                -
            {% endif %}
        </td>
        </tr>
    {% endfor %}
    </tbody>
</table>
<a href="/requests/export_excel" class="btn btn-success">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„Ø·Ù„Ø¨Ø§Øª Excel</a>
{% block scripts %}
<script>
function approveAsCompleted(requestId, btn) {
    // Ù„Ø§ ØªØ±Ø³Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø·Ù„Ø§Ù‚Ø§Ù‹ Ù‡Ù†Ø§!
    fetch(`/requests/${requestId}/approve`, {method: 'POST'})
        .then(resp => {
            if (!resp.ok) {
                return resp.json().then(err => { throw err; });
            }
            return resp.json();
        })
        .then(data => {
            document.getElementById(`msg-${requestId}`).innerText = "âœ… ØªÙ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ ÙƒÙ…ÙƒØªÙ…Ù„!";
            btn.disabled = true;
        })
        .catch(err => {
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£: " + (err.detail || "ØªØ¹Ø°Ø± ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ©"));
        });
}
</script>
{% endblock %}
{% endblock %}